<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saisie PINs La Terrasse</title>
    <style>
        /* --- Styles CSS Adaptés --- */
        :root {
            --dark-blue: #2c3e50;
            --medium-blue: #34495e;
            --light-blue: #00ff0071; /* Original green for positive actions/focus */
            --lighter-blue: #2980b9;
            --text-color: white;
            --light-text-color: #ecf0f1;
            --red: #e74c3c;
            --dark-red: #c0392b;
            --green: #2ecc71; /* A standard green for success */
            --dark-green: #27ae60; /* Darker green for hover */
            --focused-color: #ff6b35;
            --shadow-color: rgba(0,0,0,0.3);
            --focused-shadow-color: rgba(255, 107, 53, 0.3);
            --disabled-color: #7f8c8d;
            --background-input: #1a252f; /* Background for the input field */
            --bright-red: #ff0000;
            --info-blue: #3498db; /* A distinct blue for info messages */
            --dark-info-blue: #2980b9;
            --fluo-orange: #FF6600; /* Fluorescent Orange for messages */
            /* Nouvelles variables pour le tableau */
            --table-header-bg: var(--medium-blue);
            --table-border-color: #4a6278; /* Un gris-bleu plus sombre pour les bordures */
            --table-row-even-bg: #3c5268; /* Couleur plus claire pour les lignes paires */
            --table-row-hover-bg: #4a6278; /* Hover plus clair sur les lignes */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .pulse {
            animation: pulse 0.3s ease-in-out;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--dark-blue), var(--medium-blue)); /* Restored background */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 10px;
            color: var(--light-text-color);
        }

        .container-table {
            
            border-radius: 1px;
            box-shadow: none; /* Removed shadow as requested */
            width: 100%;
            max-width: 400px; /* Largeur maximale réduite pour l'ensemble du tableau */
            padding: 15px;
            color: var(--text-color);
            transition: all 0.3s ease;
        }

        h1 {
            text-align: center;
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--light-text-color);
            line-height: 1.3;
            padding-bottom: 8px;
        }
        
        .message {
            border-radius: 10px;
            margin-bottom: 10px;
            padding: 10px;
            text-align: center;
            min-height: 3.8em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: bold;
            color: var(--fluo-orange);
            background: transparent;
          
            box-sizing: border-box;
        }

        .message.success {
            color: var(--green);
           
        }

        .message.error {
            color: var(--bright-red);
            border-color: var(--bright-red);
            font-weight: bold;
            font-size: 16px;
        }

        .message.info {
            color: var(--info-blue);
            border-color: var(--info-blue);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); /* Restored shadow */
            background-color: var(--medium-blue);
            border-radius: 10px;
            overflow: hidden;
        }

        th, td {
            border: 1px solid var(--table-border-color);
            padding: 4px; /* Padding global réduit pour la compacité */
            text-align: left;
            vertical-align: middle;
            color: var(--light-text-color);
            font-size: 0.9em; /* Taille de police unifiée pour toutes les lignes */
            line-height: 1.2; /* Interlignage réduit */
            height: 30px; /* Hauteur fixe pour les cellules */
        }
        
        /* 1ère colonne: PIN */
        th:nth-child(1),
        td:nth-child(1) {
            width: 90px;
            text-align: center;
        }

        /* 2ème colonne: ARRIVEE */
        th:nth-child(2), td:nth-child(2) {
            width: 180px; /* Largeur ajustée pour ARRIVEE */
            text-align: center; /* Centre le contenu et libellé */
        }

        /* 3ème colonne: DEPART */
        th:nth-child(3), td:nth-child(3) {
            width: 180px; /* Largeur ajustée pour DEPART */
            text-align: center; /* Centre le contenu et libellé */
        }

        /* 4ème colonne: Actions (sans bordure ni fond distinct pour les cellules de données) */
        th:nth-child(4),
        td:nth-child(4) {
            width: 50px; /* Plus petit pour juste les boutons */
            text-align: center;
            background: transparent; /* Pas de fond pour cette cellule */
            box-shadow: none;
            display: flex; /* Utiliser flex pour centrer les boutons */
            align-items: center;
            justify-content: center;
            gap: 2px; /* Petit espacement entre les boutons d'action */
        }
        /* Assurer que la 4ème colonne du thead ait une bordure et un fond */
        th:nth-child(4) {
            border: 1px solid var(--table-border-color); /* Remettre la bordure pour le header */
            background-color: var(--table-header-bg); /* Remettre le fond pour le header */
        }

        th {
            background-color: var(--table-header-bg);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.9em; /* Taille de police unifiée pour toutes les lignes */
            color: var(--text-color);
        }

        tr:nth-child(even) {
            background-color: var(--table-row-even-bg);
        }

        tr:hover:not(#newEntryRow) {
            background-color: var(--table-row-hover-bg);
            cursor: pointer;
        }

        /* Style pour les inputs dans le tableau (saisie et modification) */
        td input[type="text"],
        td input[type="datetime-local"] {
            background: var(--background-input);
            border-radius: 5px;
            padding: 4px 3px; /* Padding très réduit pour les inputs */
            margin: 0;
            width: 100%; /* Occupe toute la largeur de sa cellule */
            height: 100%; /* Occupe toute la hauteur de sa cellule */
            font-size: 0.9em; /* Taille de police inputs unifiée */
            color: var(--light-text-color);
            border: none; /* Pas de bordure sur l'input, la cellule a déjà une bordure */
            outline: none;
            transition: all 0.2s ease;
            box-sizing: border-box;
            text-transform: uppercase;
            text-align: center; /* Centre le contenu des inputs */
        }
        td input[type="text"] {
             text-align: center;
        }

        /* Augmenter la taille du texte de la ligne de saisie */
        #newEntryRow input {
            font-size: 0.9em; /* Taille identique pour la ligne d'ajout pour uniformité */
            padding: 4px 3px; /* Padding identique pour la ligne d'ajout pour uniformité */
        }

        td input[type="text"]:focus,
        td input[type="datetime-local"]:focus {
            border-color: var(--focused-color); /* Le focus peut se voir sur la bordure de la cellule ou une ombre */
            box-shadow: 0 0 5px var(--focused-shadow-color) inset; /* Ombre interne pour le focus */
        }
        /* Pour les datetime-local, réactiver la flèche native si elle était cachée */
        input[type="datetime-local"]::-webkit-calendar-picker-indicator {
            background: unset;
            color: unset;
            cursor: pointer;
            width: unset;
            height: unset;
            position: unset;
            top: unset;
            left: unset;
        }
        /* Pour Firefox */
        input[type="datetime-local"] {
            -moz-appearance: auto; /* Permet l'affichage de l'indicateur natif */
        }
        input[type="datetime-local"]::-moz-calendar-picker-indicator {
            opacity: 1; /* S'assurer qu'il est visible */
            pointer-events: auto; /* S'assurer qu'il est cliquable */
        }


        /* Boutons d'action dans le tableau (colonne 4) */
        .action-buttons-container {
            display: flex;
            gap: 2px; /* Petit espacement entre les boutons */
            justify-content: center;
            align-items: center;
            /* Ces propriétés sont déjà sur la td:nth-child(4), mais pour être sûr */
            border: none !important;
            background: transparent !important;
        }

        .add, .edit, .delete, .save, .cancel {
            width: 28px; /* Taille des icônes ajustée pour la compacité */
            height: 28px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em; /* Taille des symboles */
            font-weight: bold;
            background: transparent;
            box-shadow: none;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        /* Couleurs spécifiques et épaisseur des symboles */
        .add { 
            color: var(--green); 
            font-size: 1.5em; /* Symbole '+' plus grand */
            font-weight: bolder; /* Symbole '+' plus épais */
        }
        .add:hover { background-color: rgba(var(--green), 0.15); } 

        .edit { color: white; } /* Crayon blanc */
        .edit:hover { background-color: rgba(255,255,255, 0.15); }

        .delete { color: var(--red); }
        .delete:hover { background-color: rgba(var(--red), 0.15); }

        .save { color: var(--green); }
        .save:hover { background-color: rgba(var(--green), 0.15); }

        .cancel { color: var(--disabled-color); }
        .cancel:hover { background-color: rgba(var(--disabled-color), 0.15); }


        /* Styles Responsive pour les petits écrans */
        @media screen and (max-width: 768px) {
            body {
                padding: 5px;
            }
            .container-table {
                padding: 10px;
                max-width: 100%;
            }
            h1 {
                font-size: 20px;
                margin-bottom: 15px;
            }
            .message {
                font-size: 12px;
                padding: 8px;
                min-height: 3.5em;
            }
            .message.error {
                font-size: 14px;
            }

            table, thead, tbody, th, td, tr {
                display: block;
            }

            thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }

            tr {
                margin-bottom: 10px;
                border: 1px solid var(--table-border-color);
                box-shadow: 0 2px 8px rgba(0,0,0,0.1); /* Restored shadow */
                border-radius: 8px;
                overflow: hidden;
            }

            td {
                border: none;
                border-bottom: 1px solid #3c5268;
                position: relative;
                padding-left: 40%;
                text-align: right;
                min-height: 40px; /* Hauteur des cellules un peu plus généreuse sur mobile */
                display: flex;
                align-items: center;
                justify-content: flex-end;
                height: auto; /* Supprimer la hauteur fixe sur mobile */
            }

            td:last-child {
                border-bottom: none;
                padding-bottom: 8px;
                justify-content: center;
                flex-wrap: wrap;
            }
            /* Reset specific td styles for mobile when display:block */
            td:nth-child(1), td:nth-child(2), td:nth-child(3) { /* PIN, ARRIVEE, DEPART */
                width: auto; /* Supprimer les largeurs fixes */
                border-left: 1px solid var(--table-border-color); /* Remettre les bordures */
                border-right: 1px solid var(--table-border-color); /* Remettre les bordures */
                padding: 8px 6px; /* Remettre le padding standard mobile */
                background: var(--table-row-even-bg); /* Remettre un fond */
            }
            /* Colonne d'action, doit rester transparente sur mobile */
            td:nth-child(4) {
                background: transparent;
                border: none;
            }

            td:before {
                position: absolute;
                top: 50%;
                left: 8px;
                width: 35%;
                padding-right: 8px;
                white-space: nowrap;
                text-align: left;
                font-weight: bold;
                color: var(--light-text-color);
                transform: translateY(-50%);
                font-size: 0.85em;
            }

            /* Labels pour les colonnes en mode mobile */
            td:nth-of-type(1):before { content: "PIN:"; }
            td:nth-of-type(2):before { content: "ARRIVEE:"; }
            td:nth-of-type(3):before { content: "DEPART:"; }
            td:nth-of-type(4):before { content: "ACTIONS:"; }

            #newEntryRow td {
                text-align: left;
                justify-content: flex-start;
                padding-left: 10px;
            }
            #newEntryRow td:before { content: none; }
            #newEntryRow .add {
                width: 100%;
                height: auto;
                padding: 8px 10px; /* Padding du bouton Ajouter sur mobile */
                font-size: 1.2em; /* Taille de police du bouton Ajouter sur mobile */
                margin: 4px 0;
                background-color: var(--green); /* Le bouton Ajouter garde un fond sur mobile */
                color: var(--text-color);
                box-shadow: 0 2px 5px rgba(0,0,0,0.2); /* Restored shadow */
                font-weight: bold; /* S'assurer qu'il est bien gras */
            }
            #newEntryRow .add:hover {
                background-color: var(--dark-green);
            }

            input[type="text"], input[type="datetime-local"] {
                width: calc(100% - 2px);
                margin: 0;
                font-size: 0.9em; /* Taille de police des inputs mobile ajustée */
                padding: 6px;
            }
            #newEntryRow input {
                font-size: 0.9em; /* Ligne de saisie même taille que les autres sur mobile */
                padding: 6px;
            }

            /* Boutons d'action sur mobile */
            .add, .edit, .delete, .save, .cancel {
                width: 35px; /* Taille légèrement plus grande pour la facilité de clic */
                height: 35px;
                font-size: 1.3em; /* Symboles plus grands */
            }
            .add { font-size: 1.8em; } /* Rendre le + encore plus gros sur mobile */

            /* inputs dans les td sur mobile */
            td input[type="text"], td input[type="datetime-local"] {
                width: 100%; /* L'input prend toute la largeur disponible dans la cellule mobile */
                height: auto; /* Hauteur auto pour l'input sur mobile */
            }
        }

        /* Pour les très petits écrans (ex: petits smartphones) */
        @media screen and (max-width: 480px) {
            h1 { font-size: 18px; margin-bottom: 10px; }
            .message { font-size: 11px; padding: 6px; min-height: 3em; }
            .message.error { font-size: 13px; }
            td { padding-left: 35%; }
            td:before { width: 30%; font-size: 0.8em; }
            .add, .edit, .delete, .save, .cancel {
                width: 30px; /* Taille des boutons sur très petits écrans */
                height: 30px;
                font-size: 1.2em;
            }
            .add { font-size: 1.6em; }
            #newEntryRow input {
                font-size: 0.9em;
                padding: 4px;
            }
        }
    </style>
</head>
<body>
    <div class="container-table">
        <h1>Gestion des PINs La Terrasse</h1>

        <div id="message" style="display: none;"></div>

        <table id="dataTable">
            <thead>
                <tr>
                    <th>PIN</th>
                    <th>ARRIVEE</th>
                    <th>DEPART</th>
                    <th></th> </tr>
            </thead>
            <tbody>
                <tr id="newEntryRow">
                    <td><input type="text" id="newPin" maxlength="4" placeholder="ABCD"></td>
                    <td><input type="datetime-local" id="newArrivalDateTime"></td>
                    <td><input type="datetime-local" id="newDepartureDateTime"></td>
                    <td><button class="add" onclick="addEntry()">+</button></td>
                </tr>
                </tbody>
        </table>
    </div>

    <script type="module">
        // Import des fonctions nécessaires du SDK Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, deleteDoc, updateDoc, addDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

        // Votre configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAez8fncKVaNuOzrTfDXmacs_2K_ptZFQI",
            authDomain: "poartailaccesspins.firebaseapp.com",
            projectId: "poartailaccesspins",
            storageBucket: "poartailaccesspins.firebasestorage.app",
            messagingSenderId: "248588255030",
            appId: "1:248588255030:web:d1a50104cbc330412cbd97"
        };

        // Initialisation de Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app); // Obtenir l'instance de Firestore
        const collectionName = "pins"; // Le nom de votre collection dans Firebase

        let editingId = null; // Pour garder une trace de l'ID de l'entrée en cours de modification

        // --- EXPOSITION DES FONCTIONS AU NIVEAU GLOBAL POUR LES BOUTONS HTML ---
        window.showMessage = showMessage;
        window.addEntry = addEntry;
        window.editEntry = editEntry;
        window.saveEdit = saveEdit;
        window.cancelEdit = cancelEdit;
        window.deleteEntry = deleteEntry;
        // --- FIN DE L'EXPOSITION ---

        // Fonction utilitaire pour afficher les messages
        function showMessage(msg, type = 'error') {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = msg;
            messageDiv.className = ''; // Réinitialise les classes
            messageDiv.classList.add('message', type); // Ajoute toujours la classe 'message' et le type
            messageDiv.style.display = 'flex'; // Utiliser flex pour centrer le contenu
            // Masquer le message après quelques secondes
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 5000);
        }

        // Convertit un timestamp Firebase en format datetime-local pour les inputs
        function formatTimestampToDatetimeLocal(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            const year = String(date.getFullYear());
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        // Fonction pour charger et afficher les données
        async function loadData() {
            const tableBody = document.querySelector('#dataTable tbody');
            // Supprimer toutes les lignes de données existantes (sauf la ligne d'ajout)
            tableBody.querySelectorAll('tr:not(#newEntryRow)').forEach(row => row.remove());
            showMessage('Chargement des données...', 'info'); // Message temporaire

            try {
                const querySnapshot = await getDocs(collection(db, collectionName));
                if (querySnapshot.empty) {
                    showMessage("Aucune donnée trouvée. Ajoutez la première entrée !", 'info');
                } else {
                    showMessage("Données chargées avec succès.", 'success');
                }

                querySnapshot.forEach((document) => {
                    const data = document.data();
                    const row = tableBody.insertRow(-1); // Insérer à la fin
                    row.id = document.id; // Stocker l'ID du document Firebase dans l'ID de la ligne

                    // Cellule PIN
                    row.insertCell(0).textContent = data.PIN || '';

                    // Cellules ARRIVEE
                    const arrivalCell = row.insertCell(1);
                    arrivalCell.textContent = data.arrivalDateTime ? new Date(data.arrivalDateTime).toLocaleString('fr-FR', {
                        year: 'numeric', month: '2-digit', day: '2-digit',
                        hour: '2-digit', minute: '2-digit', hour12: false
                    }) : '';
                    

                    // Cellules DEPART
                    const departureCell = row.insertCell(2);
                    departureCell.textContent = data.departureDateTime ? new Date(data.departureDateTime).toLocaleString('fr-FR', {
                        year: 'numeric', month: '2-digit', day: '2-digit',
                        hour: '2-digit', minute: '2-digit', hour12: false
                    }) : '';
                    
                    // Cellule Actions
                    const actionsCell = row.insertCell(3);
                    actionsCell.classList.add('action-buttons-container');
                    actionsCell.innerHTML = `
                        <button class="edit" onclick="editEntry('${document.id}')">✎</button>
                        <button class="delete" onclick="deleteEntry('${document.id}')">✖</button>
                    `;
                });
            } catch (error) {
                showMessage("Erreur de chargement des données : " + error.message, 'error');
                console.error("Erreur de chargement des données:", error);
            }
        }
        
        // Fonction pour ajouter une nouvelle entrée
        async function addEntry() {
            const pinInput = document.getElementById('newPin');
            const arrivalInput = document.getElementById('newArrivalDateTime');
            const departureInput = document.getElementById('newDepartureDateTime');

            const pin = pinInput.value.trim().toUpperCase(); // Convertir en majuscules
            const arrival = arrivalInput.value;
            const departure = departureInput.value;

            // 1. Validation des champs
            if (pin.length !== 4 || !/^[a-zA-Z0-9]{4}$/.test(pin)) {
                showMessage("Le PIN doit contenir exactement 4 caractères alphanumériques (A-Z, 0-9).", 'error');
                return;
            }
            if (!arrival || !departure) {
                showMessage("Les dates d'arrivée et de départ sont obligatoires.", 'error');
                return;
            }

            const arrivalDate = new Date(arrival);
            const departureDate = new Date(departure);

            // Vérifier si les dates sont valides (getTime() retourne NaN pour une date invalide)
            if (isNaN(arrivalDate.getTime()) || isNaN(departureDate.getTime())) {
                showMessage("Format de date/heure invalide. Veuillez utiliser le sélecteur.", 'error');
                return;
            }

            // 2. Contrôle de la date d'arrivée antérieure à la date de départ
            if (arrivalDate.getTime() >= departureDate.getTime()) {
                showMessage("La date d'arrivée doit être strictement antérieure à la date de départ.", 'error');
                return;
            }

            // 3. Envoi à Firebase
            try {
                await addDoc(collection(db, collectionName), {
                    PIN: pin,
                    arrivalDateTime: arrivalDate.getTime(), // Stocker en timestamp (millisecondes depuis l'époque UNIX)
                    departureDateTime: departureDate.getTime()
                });
                showMessage("Entrée ajoutée avec succès !", 'success');
                // Réinitialiser les champs du formulaire
                pinInput.value = '';
                arrivalInput.value = '';
                departureInput.value = '';
                loadData(); // Recharger les données pour afficher la nouvelle entrée
            } catch (error) {
                showMessage("Erreur lors de l'ajout : " + error.message, 'error');
                console.error("Erreur d'ajout:", error);
            }
        }

        // Fonction pour passer une entrée en mode modification
        async function editEntry(docId) {
            if (editingId && editingId !== docId) {
                // Gérer le cas où une autre ligne est déjà en cours d'édition
                showMessage("Veuillez terminer l'édition de la ligne actuelle avant d'en modifier une autre.", 'error');
                return;
            }
            if (editingId === docId) { // Si on clique deux fois sur le même bouton modifier
                cancelEdit(docId); // Annuler l'édition en cours
                return;
            }

            const row = document.getElementById(docId);
            if (!row) return;

            // Récupérer les cellules et leurs valeurs actuelles
            const pinCell = row.cells[0];
            const arrivalDisplayCell = row.cells[1];
            const departureDisplayCell = row.cells[2];
            const actionsCell = row.cells[3];

            const currentPin = pinCell.textContent;
            
            try {
                const documentSnapshot = await getDoc(doc(db, collectionName, docId));

                if (documentSnapshot.exists()) {
                    const data = documentSnapshot.data();
                    const currentArrivalTimestamp = data.arrivalDateTime;
                    const currentDepartureTimestamp = data.departureDateTime;

                    const currentArrivalFormatted = formatTimestampToDatetimeLocal(currentArrivalTimestamp);
                    const currentDepartureFormatted = formatTimestampToDatetimeLocal(currentDepartureTimestamp);

                    // Remplacer le texte par des inputs
                    pinCell.innerHTML = `<input type="text" id="editPin_${docId}" value="${currentPin}" maxlength="4">`;
                    
                    arrivalDisplayCell.innerHTML = `<input type="datetime-local" id="editArrival_${docId}" value="${currentArrivalFormatted}">`;
                    departureDisplayCell.innerHTML = `<input type="datetime-local" id="editDeparture_${docId}" value="${currentDepartureFormatted}">`;

                    // Mettre à jour les boutons d'action
                    actionsCell.innerHTML = `
                        <button class="save" onclick="saveEdit('${docId}')">✔</button>
                        <button class="cancel" onclick="cancelEdit('${docId}')">✖</button>
                    `;
                    editingId = docId;
                    showMessage("Mode édition activé pour l'entrée.", 'info');
                } else {
                    showMessage("Document non trouvé pour l'édition.", 'error');
                }
            } catch (error) {
                showMessage("Erreur lors de la récupération des données pour édition : " + error.message, 'error');
                console.error("Erreur de récupération pour édition:", error);
            }
        }

        // Fonction pour sauvegarder les modifications
        async function saveEdit(docId) {
            const pinInput = document.getElementById(`editPin_${docId}`);
            const arrivalInput = document.getElementById(`editArrival_${docId}`);
            const departureInput = document.getElementById(`editDeparture_${docId}`);

            const pin = pinInput.value.trim().toUpperCase();
            const arrival = arrivalInput.value;
            const departure = departureInput.value;

            // 1. Validation des champs (similaire à addEntry)
            if (pin.length !== 4 || !/^[a-zA-Z0-9]{4}$/.test(pin)) {
                showMessage("Le PIN doit contenir exactement 4 caractères alphanumériques (A-Z, 0-9).", 'error');
                return;
            }
            if (!arrival || !departure) {
                showMessage("Les dates d'arrivée et de départ sont obligatoires.", 'error');
                return;
            }

            const arrivalDate = new Date(arrival);
            const departureDate = new Date(departure);

            if (isNaN(arrivalDate.getTime()) || isNaN(departureDate.getTime())) {
                showMessage("Format de date/heure invalide. Veuillez utiliser le sélecteur.", 'error');
                return;
            }

            if (arrivalDate.getTime() >= departureDate.getTime()) {
                showMessage("La date d'arrivée doit être strictement antérieure à la date de départ.", 'error');
                return;
            }

            // 2. Mise à jour dans Firebase
            try {
                await updateDoc(doc(db, collectionName, docId), {
                    PIN: pin,
                    arrivalDateTime: arrivalDate.getTime(),
                    departureDateTime: departureDate.getTime()
                });
                showMessage("Entrée modifiée avec succès !", 'success');
                editingId = null; // Réinitialiser l'ID d'édition
                loadData(); // Recharger les données pour afficher les modifications
            } catch (error) {
                showMessage("Erreur lors de la modification : " + error.message, 'error');
                console.error("Erreur de modification:", error);
            }
        }

        // Fonction pour annuler la modification
        function cancelEdit(docId) {
            editingId = null; // Réinitialiser l'ID d'édition
            loadData(); // Recharger les données pour annuler les modifications non sauvegardées
            showMessage("Modification annulée.", 'info');
        }

        // Fonction pour supprimer une entrée
        async function deleteEntry(docId) {
            if (confirm("Êtes-vous sûr de vouloir supprimer cette entrée ? Cette action est irréversible.")) {
                try {
                    await deleteDoc(doc(db, collectionName, docId));
                    showMessage("Entrée supprimée avec succès !", 'success');
                    loadData(); // Recharger les données pour retirer l'entrée supprimée
                } catch (error) {
                    showMessage("Erreur lors de la suppression : " + error.message, 'error');
                    console.error("Erreur de suppression:", error);
                }
            }
        }

        // Charger les données au chargement de la page
        window.onload = loadData;
    </script>
</body>
</html>
